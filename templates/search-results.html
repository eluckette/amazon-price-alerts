{% extends 'base.html' %}
{% block content %}

<div class="container">
	<h3>Results for X?!</h3>

	<form action='/search-amazon' class='form-inline'>
	<label>Search:
		<select name='category' class='form-control'>
			<option value='Apparel'>Apparel</option>
			<option value='Beauty'>Beauty</option>
			<option value='Books'>Books</option>
			<option value='Electronics'>Electronics</option>
			<option value='Shoes'>Shoes</option>
			<option value='Tools'>Tools</option>
			<option value='Toys'>Toys</option>
		</select>
		<input type='search' name='user_input'>
	</label>
	<input type='submit' class='btn btn-default'>
	</form>
	
	<p>Showing results x?! to x?!</p>
	<table class="table" id="searchTable">
		<tr>
		</tr>
	</table>

	
	<div id="search_element">
	</div>

	<div id="pagination">
		{% for page in range(pages) %}
			<button type="button" class="btn btn-primary pagination" id="{{ page + 1 }}">{{ page +1 }}</button>
		{% endfor %}
	<div>


	<!-- Modal Shows When Button Clicked -->
	<div class="modal fade" id="setNotification" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" data-backdrop="false">
	  <div class="modal-dialog">
	    <div class="modal-content">
	      
	      <div class="modal-header">
	        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
	        <h4 class="modal-title" id="myModalLabel">Set Price Notification</h4>
	      </div>

	      <div class="modal-body">
	      </div>
	      
	      <div class="modal-footer">
	        <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
	      </div>
	    
	    </div>
	  </div>
	</div>

</div>

<script>
	$(document).ready(function() {
		getResults(1);
	});

	function refresh(evt) {
		getResults(evt.currentTarget.id);
	}

	function getResults(page_number) { 
		$.get('/paginate-search/'+page_number, function(results){
			insertResults(results);
		});
		$('html,body').scrollTop(0)
	}

	function insertResults(results) {
		// $('#search_element').empty();
		for(var i=document.getElementById("searchTable").rows.length; i>1; i--) {
			document.getElementById("searchTable").deleteRow(i-1);
		}

		var table = document.getElementById("searchTable");

		for (item in results) {
			for (i = 0; i < 20; i=i+4) {
				// $("#search_element").append("<img src="+results[item][i].Image_URL+">"+
				// 							"<p>"+results[item][i].Title+"</p>"+
				// 							"<p>"+results[item][i].Price_f+"</p>"+
				// 							"<button type='button' class='triggerModal btn btn-primary' data-target='#setNotification' data-asin='" +results[item][i].ASIN +"' data-title='" +results[item][i].Title +"' data-image='" +results[item][i].Image_URL +"'data-price='" +results[item][i].Price +"' data-price_f='" +results[item][i].Price_f +"'>Set Notification</button>"+"<br>")

				var row = table.insertRow(1);
				var cell1 = row.insertCell(0);
				var cell2 = row.insertCell(1);
				var cell3 = row.insertCell(2);
				var cell4 = row.insertCell(3);

				cell1.innerHTML = "<img src="+results[item][i].Image_URL+">"+"<br>"+
								  "<a href='#' class='triggerModal' data-target='#setNotification' data-asin='" +results[item][i].ASIN +"' data-title='" +results[item][i].Title +"' data-image='" +results[item][i].Image_URL +"'data-price='" +results[item][i].Price +"' data-price_f='" +results[item][i].Price_f +"'>"+results[item][i].Title+"</a>"+"<br>"+
								  "<p>"+results[item][i].Price_f+"</p>";

				
				cell2.innerHTML = "<img src="+results[item][i+1].Image_URL+">"+
								  "<p>"+results[item][i+1].Title+"</p>"+
								  "<p>"+results[item][i+1].Price_f+"</p>"+
								  "<button type='button' class='triggerModal btn btn-primary' data-target='#setNotification' data-asin='" +results[item][i+1].ASIN +"' data-title='" +results[item][i+1].Title +"' data-image='" +results[item][i+1].Image_URL +"'data-price='" +results[item][i+1].Price +"' data-price_f='" +results[item][i+1].Price_f +"'>Set Notification</button>"+"<br>";
				
				cell3.innerHTML = "<img src="+results[item][i+2].Image_URL+">"+
								  "<p>"+results[item][i+2].Title+"</p>"+
								  "<p>"+results[item][i+2].Price_f+"</p>"+
								  "<button type='button' class='triggerModal btn btn-primary' data-target='#setNotification' data-asin='" +results[item][i+2].ASIN +"' data-title='" +results[item][i+2].Title +"' data-image='" +results[item][i+2].Image_URL +"'data-price='" +results[item][i+2].Price +"' data-price_f='" +results[item][i+2].Price_f +"'>Set Notification</button>"+"<br>";
				
				cell4.innerHTML = "<img src="+results[item][i+3].Image_URL+">"+
								  "<p>"+results[item][i+3].Title+"</p>"+
								  "<p>"+results[item][i+3].Price_f+"</p>"+
								  "<button type='button' class='triggerModal btn btn-primary' data-target='#setNotification' data-asin='" +results[item][i+3].ASIN +"' data-title='" +results[item][i+3].Title +"' data-image='" +results[item][i+3].Image_URL +"'data-price='" +results[item][i+3].Price +"' data-price_f='" +results[item][i+3].Price_f +"'>Set Notification</button>"+"<br>";
			};
		};
		$('.triggerModal').on('click', setModal);	
	}

	function setModal(evt) {

		var data = $(this).data();

		$('.modal-body').empty();
		$('.modal-body').html("<img src="+data.image+"> <br>"+ 
							  data.title+ "<br>" +
							  data.price_f+ 
							  "<form> <label for='alert-price-field'>Set Price:</label> <input type='number' min='0' max='100' name='alert-price' id='alert-price-field'> <label for'alert-length-field'>Length of Notification (Days):</label> <input type='number' min='1' max='5' name='alert-length' id='alert-length-field'> </form><button type='button' class='submit-item btn btn-default' data-title='"+data.title+"' data-price='"+data.price+"' data-asin='"+data.asin+"'>Submit</button>");
		
		$('#setNotification').modal('show');
		$('.submit-item').on("click", saveItemAndAlert);
	}
	
	function saveItemAndAlert(evt) {
		
		var data = $(this).data();
		var alert_length = $('#alert-length-field').val();
		var alert_price = $('#alert-price-field').val();

		$.post("/alert-data", 
			{asin: data.asin,
			 title: data.title,
			 price: data.price,
			 alert_price: alert_price,
			 alert_length: alert_length}, 

			function (result) {
				$('#setNotification').modal('hide');
		});
	}	

	$('.pagination').on('click', refresh);
</script>

{% endblock %}
